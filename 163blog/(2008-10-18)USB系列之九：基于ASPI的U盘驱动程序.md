# USB系列之九：基于ASPI的U盘驱动程序  
**2008-10-18 00:08:14**

>  USB系列之七和之八介绍了ASPI，并通过一些实例说明了基于ASPI的编程方法，本文使用前两篇文章介绍的知识以及以前介绍的有关DOS驱动程序下驱动程序的内容实际完成一个简单的基于ASPI的U盘驱动程序，算是对ASPI应用的一个总结。

>  在《USB系列之六》中，我们完成了一个简单的基于DOSUSB的U盘驱动程序，实际上我们今天的程序是在那个程序的基础上改的，基本结构完全相同，思路也完全一样，只是由于有ASPI的支持，无需再读取各种描述符表，读盘、写盘的操作也显得简洁了很多，希望对本文有兴趣的读者首先了解一下《USB系列之六》中程序的结构和思路，并认真理解《USB系列之七》、《USB系列之八》两篇文章。

>  下面是本文涉及的基于ASPI的U盘驱动程序的源程序的下载地址：http://blog.whowin.net/source/aspiusb.zip

>  程序本身没有什么可说的，因为如果仔细研究过《USB系列之六》的读者应该对程序结构非常熟悉，变化最大的部分当属初始化部分，另外几个子程序：readSec、writeSec、isReady和readCapa和《USB系列之六》中完全不一样，但概念也是一样的，都是请求device执行一个SCSI命令，其它部分连代码都是一样的，下面仅就其中的一些个人认为比较有特点的地方说一下：

* 在标号begin后面有大约10几行的程序被注释掉了，这是专门为初始化部分调试编的，这段程序首先构造了一个Request Header，然后把驱动程序的中断例程地址压入堆栈，使ES:BX指向这个Request Header，最后跳到程序的策略例程上执行，当策略例程执行完后的retf指令将使程序直接执行中断例程（因为前面在堆栈里压入了中断例程的地址），这种方法我们已经多次用到，这样，只要我们把这个程序用debug调入到地址偏移0的位置，把ip寄存器改为0，就可以跟踪初始化部分的运行了，这是一种调试驱动程序初始化部分的方法。
* 关于BPB表的返回很有意思。在初始化部分，最后在Request Header中返回BPB时，需要返回BPB指针的指针，所以在程序中有一个bpb_ptr的变量，初始化时一定要返回这个变量的段地址和偏移地址，而不是返回BPB表的段地址和偏移地址；但在驱动程序执行Get BPB调用（Command Code = 2）时，返回的却是BPB的段地址和偏移地址，而不是bpb_ptr这个变量的段地址和偏移地址，不知道我说清楚了没有。之所以强调这一点，是因为我在《USB系列之六》中的基于DOSUSB的驱动程序中，在初始化部分返回的不对。
* 程序中可能还残留着一些基于DOSUSB的U盘驱动程序中的已经没有用的变量，请不要介意，自行删掉吧。